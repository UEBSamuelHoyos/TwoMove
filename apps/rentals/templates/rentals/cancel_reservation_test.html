<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Cancelar Reserva</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4 bg-light">

  <div class="container">
    <h2 class="mb-4">Cancelar Reserva</h2>

    <!-- Selector de reservas -->
    <div class="mb-3">
      <label for="reservaSelect" class="form-label">Selecciona tu reserva</label>
      <select id="reservaSelect" class="form-select"></select>
    </div>

    <!-- Motivo -->
    <div class="mb-3">
      <label for="reason" class="form-label">Motivo de cancelación</label>
      <input type="text" id="reason" class="form-control" placeholder="Ej: Cambio de planes">
    </div>

    <button id="cancelBtn" class="btn btn-danger">Cancelar Reserva</button>

    <div id="msg" class="mt-3"></div>
  </div>

  <script>
    const API_BASE = '/alquileres/api/rentals';

    // === Obtener token CSRF desde la cookie ===
    function getCSRFToken() {
      const name = 'csrftoken';
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + '=')) {
          return decodeURIComponent(cookie.substring(name.length + 1));
        }
      }
      return '';
    }

    // === Cargar reservas del usuario autenticado ===
    async function cargarReservas() {
      const msg = document.getElementById('msg');
      msg.innerHTML = '';
      const select = document.getElementById('reservaSelect');
      select.innerHTML = '';

      try {
        const res = await fetch(`${API_BASE}/mis_reservas/`, { credentials: 'include' });
        if (!res.ok) throw new Error(`Error HTTP ${res.status}`);

        const reservas = await res.json();

        if (!reservas.length) {
          select.innerHTML = `<option>No tienes reservas activas</option>`;
          document.getElementById('cancelBtn').disabled = true;
          return;
        }

        document.getElementById('cancelBtn').disabled = false;

        reservas.forEach(r => {
          const opt = document.createElement('option');
          const fecha = r.fecha_reserva || "Sin fecha";
          const hora = r.hora_reserva || "";
          const origen = r.estacion_origen || "Desconocida";
          const estado = r.estado || "";
          const tipo = r.tipo_viaje === "ultima_milla" ? "Última Milla" : "Recorrido Largo";
          const costo = r.costo_estimado ? ` - $${r.costo_estimado}` : "";
          opt.value = r.id;
          opt.textContent = `${fecha} ${hora} | ${tipo} (${origen}) - ${estado}${costo}`;
          select.appendChild(opt);
        });

      } catch (error) {
        console.error(error);
        msg.innerHTML = `<div class="alert alert-danger">❌ Error al obtener reservas.</div>`;
      }
    }

    // === Cancelar la reserva seleccionada ===
    async function cancelarReserva() {
      const id = document.getElementById('reservaSelect').value;
      const reason = document.getElementById('reason').value.trim();
      const msg = document.getElementById('msg');

      msg.innerHTML = '';

      if (!id || id === "No tienes reservas activas") {
        msg.innerHTML = `<div class="alert alert-warning">⚠️ Selecciona una reserva válida.</div>`;
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/cancel_general/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(), // ✅ CSRF agregado
          },
          credentials: 'include',
          body: JSON.stringify({ rental_id: id, reason })
        });

        if (res.ok) {
          msg.innerHTML = `<div class="alert alert-success">✅ Reserva cancelada correctamente.</div>`;
          await cargarReservas();
        } else {
          const err = await res.json();
          msg.innerHTML = `<div class="alert alert-danger">❌ Error: ${err.detail || 'No se pudo cancelar la reserva.'}</div>`;
        }

      } catch (error) {
        console.error(error);
        msg.innerHTML = `<div class="alert alert-danger">❌ Error inesperado al cancelar la reserva.</div>`;
      }
    }

    document.getElementById('cancelBtn').addEventListener('click', cancelarReserva);
    window.addEventListener('DOMContentLoaded', cargarReservas);
  </script>

</body>
</html>
