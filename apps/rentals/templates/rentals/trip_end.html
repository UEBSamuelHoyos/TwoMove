{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Finalizar viaje - TwoMove</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <!-- üîí CSRF token embebido -->
  <meta name="csrf-token" content="{{ csrf_token }}">
</head>

<body class="bg-light">
<div class="container py-5">
  <div class="card shadow-lg border-0">
    <div class="card-header bg-primary text-white text-center">
      <h4 class="mb-0">üö≤ Finalizar mi viaje</h4>
    </div>

    <div class="card-body">
      <p class="text-muted mb-4">
        Este bot√≥n cerrar√° tu viaje activo y generar√° la factura autom√°ticamente.
      </p>

      <div id="alerta" style="display:none;" class="alert" role="alert"></div>

      <div id="viaje-info" style="display:none;">
        <h6>üìç Viaje activo detectado:</h6>
        <ul class="list-group mb-3">
          <li class="list-group-item"><strong>Origen:</strong> <span id="origen"></span></li>
          <li class="list-group-item"><strong>Destino:</strong> <span id="destino"></span></li>
          <li class="list-group-item"><strong>Bicicleta:</strong> <span id="bici"></span></li>
        </ul>
        <button id="finalizarBtn" class="btn btn-success w-100">‚úÖ Finalizar viaje</button>
      </div>
    </div>

    <div id="resultado" class="card-footer bg-light" style="display:none;">
      <h5 class="text-success text-center">üìã Resultados del viaje</h5>
      <ul class="list-group">
        <li class="list-group-item"><strong>Costo total:</strong> <span id="res_costo"></span> COP</li>
        <li class="list-group-item"><strong>Duraci√≥n:</strong> <span id="res_duracion"></span> min</li>
        <li class="list-group-item"><strong>Estaci√≥n destino:</strong> <span id="res_destino"></span></li>
      </ul>
    </div>
  </div>
</div>

<script>
// === üîí Obtener token CSRF desde cookies o meta ===
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== "") {
    const cookies = document.cookie.split(";");
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + "=")) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
const csrftoken = getCookie("csrftoken") || document.querySelector('meta[name="csrf-token"]').content;
axios.defaults.headers.common["X-CSRFToken"] = csrftoken;

// === üö≤ Cargar viaje activo ===
async function cargarViajeActivo() {
  try {
    const res = await axios.get("/alquileres/api/rentals/mis_reservas/");
    const reservas = res.data || [];
    const activa = reservas.find(r => r.estado === "activo");

    if (!activa) {
      mostrarAlerta("No tienes ning√∫n viaje activo actualmente.", "warning");
      return;
    }

    document.getElementById("viaje-info").style.display = "block";
    document.getElementById("origen").innerText = activa.estacion_origen;
    document.getElementById("destino").innerText = activa.estacion_destino || "No especificada";
    document.getElementById("bici").innerText = activa.bike_serial_reservada || "N/A";
    document.getElementById("finalizarBtn").onclick = () => finalizarViaje(activa.id);

  } catch (err) {
    mostrarAlerta("Error al cargar tus reservas activas.", "danger");
    console.error(err);
  }
}

// === ‚úÖ Finalizar viaje ===
async function finalizarViaje(rental_id) {
  try {
    const res = await axios.post("/alquileres/api/rentals/end_trip/", { rental_id });
    const data = res.data;

    document.getElementById("resultado").style.display = "block";
    document.getElementById("res_costo").innerText = data.costo_total?.toLocaleString("es-CO");
    document.getElementById("res_duracion").innerText = data.duracion_minutos;
    document.getElementById("res_destino").innerText = data.estacion_destino || "N/A";

    mostrarAlerta(data.mensaje || "Viaje finalizado correctamente.", "success");

  } catch (err) {
    console.error(err);
    const msg = err.response?.data?.detail || err.response?.data?.error || "Error al finalizar viaje.";
    mostrarAlerta(msg, "danger");
  }
}

// === üí¨ Funci√≥n auxiliar para mostrar alertas ===
function mostrarAlerta(texto, tipo) {
  const alerta = document.getElementById("alerta");
  alerta.className = "alert alert-" + tipo;
  alerta.innerText = texto;
  alerta.style.display = "block";
}

cargarViajeActivo();
</script>
</body>
</html>
