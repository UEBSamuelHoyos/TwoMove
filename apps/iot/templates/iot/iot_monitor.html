<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel IoT - Seguimiento de Bicicletas</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f4f6f8;
      margin: 0;
      padding: 0;
    }
    h2 {
      text-align: center;
      margin: 10px 0;
      color: #0078d4;
    }
    #map {
      width: 100%;
      height: 90vh;
      border-top: 3px solid #0078d4;
    }
    .legend {
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 14px;
      line-height: 1.4;
    }
    .legend span {
      display: inline-block;
      width: 14px;
      height: 14px;
      margin-right: 5px;
      border-radius: 50%;
    }
  </style>
</head>
<body>
  <h2>ðŸš´ Seguimiento IoT en tiempo real</h2>
  <div id="map"></div>
  <div class="legend">
    <p><span style="background:#28a745"></span> Estaciones</p>
    <p><span style="background:#0078d4"></span> Ruta bicicleta</p>
    <p><span style="background:#ff0000"></span> Bicicleta actual</p>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ðŸŒ Inicializar mapa
    const map = L.map("map").setView([4.65, -74.1], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "Â© OpenStreetMap",
    }).addTo(map);

    let estacionesLayer = L.layerGroup().addTo(map);
    let routeLine = L.polyline([], { color: "#0078d4", weight: 4 }).addTo(map);
    let bikeMarker = null;

    // ðŸŸ¢ Cargar estaciones desde API
    async function cargarEstaciones() {
      const resp = await fetch("/estaciones/stations/");
      const data = await resp.json();
      estacionesLayer.clearLayers();
      data.forEach((est) => {
        if (est.latitud && est.longitud) {
          const marker = L.circleMarker([est.latitud, est.longitud], {
            color: "#28a745",
            radius: 6,
            fillOpacity: 0.9,
          }).addTo(estacionesLayer);
          marker.bindPopup(`<b>${est.nombre}</b><br>${est.direccion}`);
        }
      });
    }

    // ðŸš² Cargar posiciones IoT (telemetrÃ­a)
    let lastPositions = [];

    async function cargarTelemetria() {
      try {
        const resp = await fetch("/iot/api/telemetry/");
        const data = await resp.json();

        if (data.length === 0) return;

        // Tomar las coordenadas mÃ¡s recientes
        const latest = data[data.length - 1];
        const lat = parseFloat(latest.latitud);
        const lon = parseFloat(latest.longitud);

        if (isNaN(lat) || isNaN(lon)) return;

        lastPositions.push([lat, lon]);
        routeLine.setLatLngs(lastPositions);

        // Mover marcador de bicicleta
        if (!bikeMarker) {
          bikeMarker = L.marker([lat, lon], {
            icon: L.icon({
              iconUrl:
                "https://cdn-icons-png.flaticon.com/512/7137/7137636.png",
              iconSize: [36, 36],
              iconAnchor: [18, 18],
            }),
          }).addTo(map);
        } else {
          bikeMarker.setLatLng([lat, lon]);
        }

        bikeMarker.bindPopup(
          `ðŸš´ Bicicleta ${latest.bike_serial}<br><small>${latest.timestamp}</small>`
        );
      } catch (err) {
        console.error("Error cargando telemetrÃ­a:", err);
      }
    }

    // ðŸ”„ Actualizar cada 2 segundos
    cargarEstaciones();
    setInterval(cargarTelemetria, 2000);
  </script>
</body>
</html>
