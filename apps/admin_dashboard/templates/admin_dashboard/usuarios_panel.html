{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gesti√≥n de Usuarios - TwoMove üö≤</title>
  <link rel="stylesheet" href="{% static 'admin/css/dashboard.css' %}">
  <link rel="stylesheet" href="{% static 'admin/css/usuarios_panel.css' %}">
</head>
<body>
  <!-- HEADER -->
  <header class="dashboard-header">
    <div class="header-container">
      <div class="logo-section">
        <div class="logo-icon">
          <img
            src="{% static 'users/images/logo.png' %}"
            alt="TwoMove Logo"
            onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\'logo-fallback\'>T</div>'"
          />
        </div>
      </div>
      
      <div class="user-section">
        <div class="user-info">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
          <span>{{ request.user.email }}</span>
        </div>
        <a href="{% url 'admin_dashboard:admin_logout' %}" class="logout-btn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
          Cerrar sesi√≥n
        </a>
      </div>
    </div>
  </header>

  <!-- MAIN CONTENT -->
  <main class="dashboard-main">
    <div class="dashboard-container">
      <!-- Breadcrumb y t√≠tulo -->
      <div class="page-header">
        <div class="breadcrumb">
          <a href="{% url 'admin_dashboard:dashboard_home' %}">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            </svg>
            Inicio
          </a>
          <span>/</span>
          <span>Gesti√≥n de Usuarios</span>
        </div>
        <h2>üë• Gesti√≥n de Usuarios</h2>
        <p class="subtitle">Administra todos los usuarios del sistema</p>
      </div>

      <!-- Mensajes -->
      {% if messages %}
      <div class="messages-container">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
          <span class="alert-icon">
            {% if message.tags == 'success' %}‚úì{% elif message.tags == 'error' %}‚úï{% elif message.tags == 'warning' %}‚ö†{% else %}‚Ñπ{% endif %}
          </span>
          <span>{{ message }}</span>
          <button class="alert-close" onclick="this.parentElement.remove()">√ó</button>
        </div>
        {% endfor %}
      </div>
      {% endif %}

      <!-- Panel de b√∫squeda -->
      <div class="search-panel">
        <form method="get" class="search-form" id="searchForm">
          <div class="search-inputs">
            <div class="search-field">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
              </svg>
              <input 
                type="text" 
                name="q" 
                value="{{ q }}" 
                placeholder="Buscar por nombre, correo o celular"
                class="search-input"
              >
            </div>

            <div class="search-field">
              <select name="estado" class="search-select">
                <option value="">Todos los estados</option>
                <option value="activo" {% if request.GET.estado == "activo" %}selected{% endif %}>Activos</option>
                <option value="inactivo" {% if request.GET.estado == "inactivo" %}selected{% endif %}>Inactivos</option>
                <option value="sancionado" {% if request.GET.estado == "sancionado" %}selected{% endif %}>Sancionados</option>
              </select>
            </div>

            <button type="submit" class="btn-search">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
              </svg>
              Buscar
            </button>

            <a href="{% url 'admin_dashboard:usuarios_panel' %}" class="btn-clear">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="1 4 1 10 7 10"></polyline>
                <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
              </svg>
              Limpiar
            </a>
          </div>
        </form>

        <div class="results-info">
          <span class="total-badge">Total: {{ total }} usuario{{ total|pluralize }}</span>
        </div>
      </div>

      <!-- Tabla de usuarios -->
      <div class="users-table-container">
        <table class="users-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Nombre</th>
              <th>Email</th>
              <th>Celular</th>
              <th>Estado</th>
              <th>Activo</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for u in usuarios %}
            <tr class="user-row">
              <td class="user-id">{{ forloop.counter }}</td>
              <td class="user-name">
                <div class="name-cell">
                  <div class="avatar">{{ u.nombre|first }}{{ u.apellido|first }}</div>
                  <span>{{ u.nombre }} {{ u.apellido }}</span>
                </div>
              </td>
              <td class="user-email">{{ u.email }}</td>
              <td class="user-phone">{{ u.celular|default:"-" }}</td>
              <td class="user-status">
                {% if u.estado == "activo" %}
                  <span class="status-badge active">Activo</span>
                {% elif u.estado == "inactivo" %}
                  <span class="status-badge inactive">Inactivo</span>
                {% else %}
                  <span class="status-badge sanctioned">Sancionado</span>
                {% endif %}
              </td>
              <td class="user-active">
                {% if u.is_active %}
                  <span class="active-icon">‚úì</span>
                {% else %}
                  <span class="inactive-icon">‚úï</span>
                {% endif %}
              </td>
              <td class="user-actions">
                <button 
                  class="btn-action edit"
                  data-id="{{ u.usuario_id }}"
                  data-nombre="{{ u.nombre }}"
                  data-apellido="{{ u.apellido }}"
                  data-email="{{ u.email }}"
                  data-celular="{{ u.celular }}"
                  data-estado="{{ u.estado }}"
                  onclick="openEditModal(this)"
                  title="Editar usuario"
                >
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                  </svg>
                </button>

                {% if u.is_active %}
                <a 
                  href="{% url 'admin_dashboard:usuarios_toggle' u.usuario_id %}?activo=0"
                  class="btn-action deactivate"
                  onclick="return confirm('¬øInactivar este usuario?')"
                  title="Inactivar"
                >
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                  </svg>
                </a>
                {% else %}
                <a 
                  href="{% url 'admin_dashboard:usuarios_toggle' u.usuario_id %}?activo=1"
                  class="btn-action activate"
                  onclick="return confirm('¬øActivar este usuario?')"
                  title="Activar"
                >
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20 6 9 17 4 12"></polyline>
                  </svg>
                </a>
                {% endif %}

                <a 
                  href="{% url 'admin_dashboard:usuarios_eliminar' u.usuario_id %}"
                  class="btn-action delete"
                  onclick="return confirm('¬øEliminar definitivamente este usuario? Esta acci√≥n no se puede deshacer.')"
                  title="Eliminar"
                >
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  </svg>
                </a>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7" class="empty-state">
                <div class="empty-icon">üì≠</div>
                <p>No se encontraron usuarios</p>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Paginaci√≥n -->
      {% if usuarios.has_other_pages %}
      <div class="pagination-container">
        <nav class="pagination">
          {% if usuarios.has_previous %}
            <a href="?page={{ usuarios.previous_page_number }}{% if q %}&q={{ q }}{% endif %}{% if request.GET.estado %}&estado={{ request.GET.estado }}{% endif %}" class="page-link prev">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
              </svg>
              Anterior
            </a>
          {% endif %}

          <div class="page-numbers">
            {% for i in usuarios.paginator.page_range %}
              {% if usuarios.number == i %}
                <span class="page-number active">{{ i }}</span>
              {% else %}
                <a href="?page={{ i }}{% if q %}&q={{ q }}{% endif %}{% if request.GET.estado %}&estado={{ request.GET.estado }}{% endif %}" class="page-number">{{ i }}</a>
              {% endif %}
            {% endfor %}
          </div>

          {% if usuarios.has_next %}
            <a href="?page={{ usuarios.next_page_number }}{% if q %}&q={{ q }}{% endif %}{% if request.GET.estado %}&estado={{ request.GET.estado }}{% endif %}" class="page-link next">
              Siguiente
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"></polyline>
              </svg>
            </a>
          {% endif %}
        </nav>
      </div>
      {% endif %}
    </div>
  </main>

  <!-- Modal de edici√≥n -->
  <div class="modal-overlay" id="editModal">
    <div class="modal-container">
      <div class="modal-header">
        <h3>‚úèÔ∏è Editar Usuario</h3>
        <button class="modal-close" onclick="closeEditModal()">√ó</button>
      </div>

      <form method="post" action="{% url 'admin_dashboard:usuarios_editar' %}" id="editForm">
        {% csrf_token %}
        <input type="hidden" name="usuario_id" id="editUsuarioId">

        <div class="modal-body">
          <div class="form-row">
            <div class="form-field">
              <label for="editNombre">Nombre</label>
              <input type="text" name="nombre" id="editNombre" required>
            </div>

            <div class="form-field">
              <label for="editApellido">Apellido</label>
              <input type="text" name="apellido" id="editApellido" required>
            </div>
          </div>

          <div class="form-field">
            <label for="editEmail">Correo electr√≥nico</label>
            <input type="email" name="email" id="editEmail" required>
          </div>

          <div class="form-field">
            <label for="editCelular">Celular</label>
            <input type="text" name="celular" id="editCelular">
          </div>

          <div class="form-field">
            <label for="editEstado">Estado</label>
            <select name="estado" id="editEstado">
              <option value="activo">Activo</option>
              <option value="inactivo">Inactivo</option>
              <option value="sancionado">Sancionado</option>
            </select>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn-cancel" onclick="closeEditModal()">Cancelar</button>
          <button type="submit" class="btn-save">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
              <polyline points="17 21 17 13 7 13 7 21"></polyline>
              <polyline points="7 3 7 8 15 8"></polyline>
            </svg>
            Guardar cambios
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- FOOTER -->
  <footer class="dashboard-footer">
    <p>TwoMove ¬© {% now "Y" %} ‚Äî Panel administrativo interno</p>
  </footer>

  <script src="{% static 'admin/js/usuarios_panel.js' %}"></script>
</body>
</html>